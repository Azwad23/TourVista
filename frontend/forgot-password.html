<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password â€” TourVista</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Poppins:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    .otp-inputs { display: flex; gap: 10px; justify-content: center; margin: 24px 0; }
    .otp-inputs input {
      width: 52px; height: 60px; text-align: center; font-size: 1.5rem; font-weight: 800;
      border: 2px solid var(--border); border-radius: var(--radius); background: var(--bg);
      color: var(--text); transition: all 0.2s; font-family: 'Inter', monospace;
    }
    .otp-inputs input:focus {
      border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79,70,229,0.1); outline: none;
    }
    .otp-inputs input.filled { border-color: var(--primary); background: var(--primary-light); }
    .step { display: none; }
    .step.active { display: block; }
    .step-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 32px; }
    .step-dot {
      width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 0.85rem; font-weight: 700; border: 2px solid var(--border); color: var(--text-muted); transition: all 0.3s;
    }
    .step-dot.active { border-color: var(--primary); background: var(--primary); color: white; }
    .step-dot.done { border-color: var(--success); background: var(--success); color: white; }
    .step-line { width: 40px; height: 2px; background: var(--border); transition: background 0.3s; }
    .step-line.done { background: var(--success); }
    .resend-timer { font-size: 0.85rem; color: var(--text-muted); text-align: center; margin-top: 16px; }
    .resend-timer a { color: var(--primary); cursor: pointer; font-weight: 600; }
    .resend-timer a.disabled { color: var(--text-muted); cursor: not-allowed; pointer-events: none; }
    .password-strength { height: 4px; border-radius: 2px; margin-top: 8px; transition: all 0.3s; }
  </style>
</head>
<body>
  <div class="auth-page">
    <div class="auth-container">
      <!-- Left Visual Panel -->
      <div class="auth-visual">
        <h2>Reset Your Password</h2>
        <p>Don't worry, it happens to everyone. We'll send you a one-time code to verify your identity.</p>

        <div class="auth-visual-features">
          <div><i class="fas fa-envelope"></i> OTP sent to your email</div>
          <div><i class="fas fa-shield-alt"></i> Secure 6-digit verification</div>
          <div><i class="fas fa-clock"></i> OTP valid for 10 minutes</div>
          <div><i class="fas fa-lock"></i> Set a new strong password</div>
        </div>

        <div style="margin-top:48px;padding:20px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(10px);">
          <p style="font-size:0.85rem;opacity:0.9;line-height:1.6;">
            <i class="fas fa-lightbulb" style="color:#fbbf24;margin-right:6px;"></i>
            <strong>Tip:</strong> Check your spam/junk folder if you don't see the email in your inbox.
          </p>
        </div>
      </div>

      <!-- Right Form Panel -->
      <div class="auth-form-section">
        <a href="index.html" class="logo">
          <i class="fas fa-globe-americas"></i>
          <span>TourVista</span>
        </a>

        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step-dot active" id="dot1">1</div>
          <div class="step-line" id="line1"></div>
          <div class="step-dot" id="dot2">2</div>
          <div class="step-line" id="line2"></div>
          <div class="step-dot" id="dot3">3</div>
        </div>

        <!-- ===== STEP 1: Enter Email ===== -->
        <div class="step active" id="step1">
          <h2>Forgot Password?</h2>
          <p class="subtitle">Enter your email address and we'll send you a 6-digit OTP to reset your password.</p>

          <form class="auth-form" onsubmit="sendOTP(event)">
            <div class="form-group">
              <label class="form-label">Email Address</label>
              <div style="position:relative;">
                <i class="fas fa-envelope" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted);"></i>
                <input type="email" class="form-input" style="padding-left:40px;" id="resetEmail" placeholder="you@example.com" required>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" style="width:100%;" id="sendOtpBtn">
              <i class="fas fa-paper-plane"></i> Send OTP
            </button>
          </form>

          <div class="auth-footer" style="margin-top:24px;">
            Remember your password? <a href="login.html">Back to Login</a>
          </div>
        </div>

        <!-- ===== STEP 2: Enter OTP ===== -->
        <div class="step" id="step2">
          <h2>Verify OTP</h2>
          <p class="subtitle">Enter the 6-digit code sent to <strong id="otpEmailDisplay"></strong></p>

          <form class="auth-form" onsubmit="verifyOTP(event)">
            <div class="otp-inputs" id="otpInputs">
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
              <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" required>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" style="width:100%;" id="verifyOtpBtn">
              <i class="fas fa-check-circle"></i> Verify OTP
            </button>
          </form>

          <div class="resend-timer" id="resendArea">
            Didn't receive the code? <a id="resendLink" class="disabled" onclick="resendOTP()">Resend OTP</a>
            <span id="timerText"> in <span id="countdown">60</span>s</span>
          </div>

          <div style="text-align:center;margin-top:16px;">
            <a href="#" onclick="goToStep(1); return false;" style="font-size:0.85rem;color:var(--text-muted);">
              <i class="fas fa-arrow-left"></i> Change email
            </a>
          </div>
        </div>

        <!-- ===== STEP 3: New Password ===== -->
        <div class="step" id="step3">
          <h2>Set New Password</h2>
          <p class="subtitle">Create a strong new password for your account.</p>

          <form class="auth-form" onsubmit="resetPassword(event)">
            <div class="form-group">
              <label class="form-label">New Password</label>
              <div style="position:relative;">
                <i class="fas fa-lock" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted);"></i>
                <input type="password" class="form-input" style="padding-left:40px;" id="newPassword" placeholder="At least 6 characters" required minlength="6" oninput="checkPasswordStrength(this.value)">
                <button type="button" onclick="togglePassword('newPassword', this)" style="position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;color:var(--text-muted);font-size:0.9rem;border:none;cursor:pointer;">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
              <div class="password-strength" id="passwordStrength"></div>
              <small id="strengthText" style="font-size:0.75rem;color:var(--text-muted);"></small>
            </div>

            <div class="form-group">
              <label class="form-label">Confirm Password</label>
              <div style="position:relative;">
                <i class="fas fa-lock" style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted);"></i>
                <input type="password" class="form-input" style="padding-left:40px;" id="confirmPassword" placeholder="Re-enter password" required minlength="6">
                <button type="button" onclick="togglePassword('confirmPassword', this)" style="position:absolute;right:14px;top:50%;transform:translateY(-50%);background:none;color:var(--text-muted);font-size:0.9rem;border:none;cursor:pointer;">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>

            <button type="submit" class="btn btn-primary btn-lg" style="width:100%;" id="resetBtn">
              <i class="fas fa-key"></i> Reset Password
            </button>
          </form>
        </div>

        <!-- ===== SUCCESS ===== -->
        <div class="step" id="stepSuccess">
          <div style="text-align:center;padding:20px 0;">
            <div style="width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#d1fae5,#a7f3d0);display:flex;align-items:center;justify-content:center;margin:0 auto 20px;">
              <i class="fas fa-check" style="font-size:2rem;color:#059669;"></i>
            </div>
            <h2 style="margin-bottom:8px;">Password Reset!</h2>
            <p class="subtitle">Your password has been reset successfully. You can now log in with your new password.</p>
            <a href="login.html" class="btn btn-primary btn-lg" style="width:100%;margin-top:24px;text-decoration:none;">
              <i class="fas fa-sign-in-alt"></i> Go to Login
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script>
    let currentEmail = '';
    let resetToken = '';
    let countdownTimer = null;

    // OTP input auto-focus behavior
    document.querySelectorAll('.otp-inputs input').forEach((input, idx, inputs) => {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
        if (this.value && idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        }
        this.classList.toggle('filled', !!this.value);
      });
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Backspace' && !this.value && idx > 0) {
          inputs[idx - 1].focus();
          inputs[idx - 1].value = '';
          inputs[idx - 1].classList.remove('filled');
        }
      });
      input.addEventListener('paste', function(e) {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text').replace(/[^0-9]/g, '');
        paste.split('').forEach((ch, i) => {
          if (inputs[idx + i]) {
            inputs[idx + i].value = ch;
            inputs[idx + i].classList.add('filled');
          }
        });
        if (inputs[Math.min(idx + paste.length, inputs.length - 1)]) {
          inputs[Math.min(idx + paste.length, inputs.length - 1)].focus();
        }
      });
    });

    function goToStep(step) {
      document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
      document.getElementById('step' + step).classList.add('active');

      // Update dots
      for (let i = 1; i <= 3; i++) {
        const dot = document.getElementById('dot' + i);
        dot.classList.remove('active', 'done');
        if (i < step) dot.classList.add('done');
        else if (i === step) dot.classList.add('active');
      }
      for (let i = 1; i <= 2; i++) {
        const line = document.getElementById('line' + i);
        line.classList.toggle('done', i < step);
      }
    }

    function startCountdown() {
      let seconds = 60;
      const countdownEl = document.getElementById('countdown');
      const resendLink = document.getElementById('resendLink');
      const timerText = document.getElementById('timerText');

      resendLink.classList.add('disabled');
      timerText.style.display = '';

      if (countdownTimer) clearInterval(countdownTimer);
      countdownTimer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(countdownTimer);
          resendLink.classList.remove('disabled');
          timerText.style.display = 'none';
        }
      }, 1000);
    }

    async function sendOTP(e) {
      e.preventDefault();
      const email = document.getElementById('resetEmail').value.trim();
      if (!email) return;

      const btn = document.getElementById('sendOtpBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending OTP...';

      try {
        const res = await fetch(API_BASE + '/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Failed to send OTP');

        currentEmail = email;
        document.getElementById('otpEmailDisplay').textContent = email;
        showToast('OTP sent to your email!', 'success');
        goToStep(2);
        startCountdown();

        // Focus first OTP input
        document.querySelector('.otp-inputs input').focus();

      } catch (err) {
        showToast(err.message || 'Failed to send OTP', 'error');
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send OTP';
      }
    }

    async function resendOTP() {
      const btn = document.getElementById('resendLink');
      if (btn.classList.contains('disabled')) return;

      try {
        const res = await fetch(API_BASE + '/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail })
        });

        showToast('New OTP sent!', 'success');
        startCountdown();

        // Clear OTP inputs
        document.querySelectorAll('.otp-inputs input').forEach(inp => {
          inp.value = '';
          inp.classList.remove('filled');
        });
        document.querySelector('.otp-inputs input').focus();
      } catch (err) {
        showToast('Failed to resend OTP', 'error');
      }
    }

    async function verifyOTP(e) {
      e.preventDefault();
      const inputs = document.querySelectorAll('.otp-inputs input');
      const otp = Array.from(inputs).map(i => i.value).join('');

      if (otp.length !== 6) {
        showToast('Please enter the complete 6-digit OTP', 'warning');
        return;
      }

      const btn = document.getElementById('verifyOtpBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

      try {
        const res = await fetch(API_BASE + '/auth/verify-otp', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail, otp })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'OTP verification failed');

        resetToken = data.reset_token;
        showToast('OTP verified!', 'success');
        goToStep(3);
        document.getElementById('newPassword').focus();

      } catch (err) {
        showToast(err.message || 'Invalid OTP', 'error');
        // Shake animation on OTP inputs
        document.getElementById('otpInputs').style.animation = 'none';
        setTimeout(() => { document.getElementById('otpInputs').style.animation = ''; }, 10);
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle"></i> Verify OTP';
      }
    }

    async function resetPassword(e) {
      e.preventDefault();
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;

      if (newPass.length < 6) {
        showToast('Password must be at least 6 characters', 'warning');
        return;
      }
      if (newPass !== confirmPass) {
        showToast('Passwords do not match', 'warning');
        return;
      }

      const btn = document.getElementById('resetBtn');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';

      try {
        const res = await fetch(API_BASE + '/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail, reset_token: resetToken, new_password: newPass })
        });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Password reset failed');

        // Show success
        document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
        document.getElementById('stepSuccess').classList.add('active');

        // Mark all dots as done
        for (let i = 1; i <= 3; i++) {
          document.getElementById('dot' + i).classList.add('done');
          document.getElementById('dot' + i).classList.remove('active');
        }
        document.getElementById('line1').classList.add('done');
        document.getElementById('line2').classList.add('done');

      } catch (err) {
        showToast(err.message || 'Reset failed', 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-key"></i> Reset Password';
      }
    }

    function checkPasswordStrength(password) {
      const bar = document.getElementById('passwordStrength');
      const text = document.getElementById('strengthText');
      let strength = 0;
      if (password.length >= 6) strength++;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;

      const colors = ['#ef4444', '#f59e0b', '#f59e0b', '#22c55e', '#059669'];
      const labels = ['Weak', 'Fair', 'Fair', 'Strong', 'Very Strong'];
      const widths = ['20%', '40%', '60%', '80%', '100%'];

      const idx = Math.min(strength, 4);
      bar.style.background = colors[idx];
      bar.style.width = widths[idx];
      text.textContent = password.length > 0 ? labels[idx] : '';
      text.style.color = colors[idx];
    }

    function togglePassword(inputId, btn) {
      var input = document.getElementById(inputId);
      var icon = btn.querySelector('i');
      if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
      } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
      }
    }
  </script>
</body>
</html>
